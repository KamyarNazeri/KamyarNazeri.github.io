<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Orchestrator Demo</title>
<meta charset="UTF-8">
<script src="go.js"></script>
<script id="code">
  function init() {
    if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
    var $ = go.GraphObject.make;  // for conciseness in defining templates
    var yellowgrad = $(go.Brush, "Linear", { 0: "rgb(254, 201, 0)", 1: "rgb(254, 162, 0)" });
    var greengrad = $(go.Brush, "Linear", { 0: "#98FB98", 1: "#9ACD32" });
    var bluegrad = $(go.Brush, "Linear", { 0: "#B0E0E6", 1: "#87CEEB" });
    var redgrad = $(go.Brush, "Linear", { 0: "#C45245", 1: "#871E1B" });
    var whitegrad = $(go.Brush, "Linear", { 0: "#F0F8FF", 1: "#E6E6FA" });
    var bigfont = "bold 13pt Helvetica, Arial, sans-serif";
    var smallfont = "bold 11pt Helvetica, Arial, sans-serif";
    // Common text styling
    function textStyle() {
      return {
        margin: 6,
        wrap: go.TextBlock.WrapFit,
        textAlign: "center",
        editable: true,
        font: bigfont
      }
    }
    myDiagram =
      $(go.Diagram, "myDiagramDiv",
        {
          // have mouse wheel events zoom in and out instead of scroll up and down
          "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
          allowDrop: true,  // support drag-and-drop from the Palette
          initialAutoScale: go.Diagram.Uniform,
          "linkingTool.direction": go.LinkingTool.ForwardsOnly,
          initialContentAlignment: go.Spot.Center,
          layout: $(go.LayeredDigraphLayout, { isInitial: false, isOngoing: false, layerSpacing: 50 }),
          "undoManager.isEnabled": true
        });
    // when the document is modified, add a "*" to the title and enable the "Save" button
    myDiagram.addDiagramListener("Modified", function(e) {
      var button = document.getElementById("SaveButton");
      if (button) button.disabled = !myDiagram.isModified;
      var idx = document.title.indexOf("*");
      if (myDiagram.isModified) {
        if (idx < 0) document.title += "*";
      } else {
        if (idx >= 0) document.title = document.title.substr(0, idx);
      }
    });
    var defaultAdornment =
      $(go.Adornment, "Spot",
        $(go.Panel, "Auto",
          $(go.Shape, { fill: null, stroke: "dodgerblue", strokeWidth: 4 }),
          $(go.Placeholder)),
        // the button to create a "next" node, at the top-right corner
        $("Button",
          { alignment: go.Spot.TopRight,
            click: addNodeAndLink },  // this function is defined below
          new go.Binding("visible", "", function(a) { return !a.diagram.isReadOnly; }).ofObject(),
          $(go.Shape, "PlusLine", { desiredSize: new go.Size(6, 6) })
        )
      );
    // define the Node template
    myDiagram.nodeTemplate =
      $(go.Node, "Auto",
        { selectionAdornmentTemplate: defaultAdornment },
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        // define the node's outer shape, which will surround the TextBlock
        $(go.Shape, "Rectangle",
          { fill: yellowgrad, stroke: "black",
            portId: "", fromLinkable: true, toLinkable: true, cursor: "pointer",
            toEndSegmentLength: 50, fromEndSegmentLength: 40 }),
        $(go.TextBlock, "Step",
          { margin: 6,
            font: bigfont,
            editable: true },
          new go.Binding("text", "text").makeTwoWay()));
    myDiagram.nodeTemplateMap.add("Source",
      $(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        $(go.Shape, "RoundedRectangle",
          { fill: bluegrad,
          portId: "", fromLinkable: true, cursor: "pointer", fromEndSegmentLength: 40}),
        $(go.TextBlock, "Source", textStyle(),
          new go.Binding("text", "text").makeTwoWay())
        ));
    myDiagram.nodeTemplateMap.add("DesiredEvent",
      $(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        $(go.Shape, "RoundedRectangle",
          { fill: greengrad, portId: "", toLinkable: true, toEndSegmentLength: 50 }),
        $(go.TextBlock, "Complete!", textStyle(),
          new go.Binding("text", "text").makeTwoWay())
        ));
    // Undesired events have a special adornment that allows adding additional "detail"
    var UndesiredEventAdornment =
      $(go.Adornment, "Spot",
        $(go.Panel, "Auto",
          $(go.Shape, { fill: null, stroke: "dodgerblue", strokeWidth: 4 }),
          $(go.Placeholder)),
        // the button to create a "next" node, at the top-right corner
        $("Button",
          { alignment: go.Spot.BottomRight,
            click: addDetail },  // this function is defined below
          new go.Binding("visible", "", function(a) { return !a.diagram.isReadOnly; }).ofObject(),
          $(go.Shape, "TriangleDown", { desiredSize: new go.Size(10, 10) })
        )
      );
    var detailTemplate = $(go.Panel, "Horizontal",
      $(go.TextBlock, "Detail",
        {
          margin: new go.Margin(4,0,0,0),
          maxSize: new go.Size(200, NaN),
          wrap: go.TextBlock.WrapFit,
          stroke: "whitesmoke",
          editable: true,
          font: smallfont
        },
        new go.Binding("text", "text").makeTwoWay())
      );
    myDiagram.nodeTemplateMap.add("UndesiredEvent",
      $(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        { selectionAdornmentTemplate: UndesiredEventAdornment },
        $(go.Shape, "RoundedRectangle",
          { fill: redgrad, portId: "", toLinkable: true, fromLinkable: true, toEndSegmentLength: 50, cursor: "pointer" }),
        $(go.Panel, "Vertical", {defaultAlignment: go.Spot.TopLeft},
          $(go.TextBlock, "Action", textStyle(),
            { stroke: "whitesmoke",
              minSize: new go.Size(80, NaN) },
            new go.Binding("text", "text").makeTwoWay()),
          $(go.Panel, "Vertical",
            { defaultAlignment: go.Spot.TopLeft,
              itemTemplate: detailTemplate },
            new go.Binding("itemArray", "detailsList").makeTwoWay()
          )
        )
        ));
    myDiagram.nodeTemplateMap.add("Comment",
      $(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        $(go.Shape, "Rectangle",
          { portId: "", fill: whitegrad, fromLinkable: true }),
        $(go.TextBlock, "Comment",
          { margin: 9,
            maxSize: new go.Size(200, NaN),
            wrap: go.TextBlock.WrapFit,
            editable: true,
            font: smallfont },
          new go.Binding("text", "text").makeTwoWay())
        // no ports, because no links are allowed to connect with a comment
        ));
    // clicking the button on an UndesiredEvent node inserts a new text object into the panel
    function addDetail(e, obj) {
      var adorn = obj.part;
      if (adorn === null) return;
      e.handled = true;
      var arr = adorn.adornedPart.data.detailsList;
      myDiagram.startTransaction("add detail");
      myDiagram.model.addArrayItem(arr, {});
      myDiagram.commitTransaction("add detail");
    }
    // clicking the button of a default node inserts a new node to the right of the selected node,
    // and adds a link to that new node
    function addNodeAndLink(e, obj) {
      var adorn = obj.part;
      if (adorn === null) return;
      e.handled = true;
      var diagram = adorn.diagram;
      diagram.startTransaction("Add State");
      // get the node data for which the user clicked the button
      var fromNode = adorn.adornedPart;
      var fromData = fromNode.data;
      // create a new "State" data object, positioned off to the right of the adorned Node
      var toData = { text: "new" };
      var p = fromNode.location;
      toData.loc = p.x + 200 + " " + p.y;  // the "loc" property is a string, not a Point object
      // add the new node data to the model
      var model = diagram.model;
      model.addNodeData(toData);
      // create a link data from the old node data to the new node data
      var linkdata = {};
      linkdata[model.linkFromKeyProperty] = model.getKeyForNodeData(fromData);
      linkdata[model.linkToKeyProperty] = model.getKeyForNodeData(toData);
      // and add the link data to the model
      model.addLinkData(linkdata);
      // select the new Node
      var newnode = diagram.findNodeForData(toData);
      diagram.select(newnode);
      diagram.commitTransaction("Add State");
    }
    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
      $(go.Link,  // the whole link panel
        new go.Binding("points").makeTwoWay(),
        { curve: go.Link.Bezier, toShortLength: 15 },
        new go.Binding("curviness", "curviness"),
        $(go.Shape,  // the link shape
          { stroke: "#2F4F4F", strokeWidth: 2.5 }),
        $(go.Shape,  // the arrowhead
          { toArrow: "kite", fill: "#2F4F4F", stroke: null, scale: 2 })
    );
    myDiagram.linkTemplateMap.add("Comment",
      $(go.Link, { selectable: false },
        $(go.Shape, { strokeWidth: 2, stroke: "darkgreen" })));
    var palette =
      $(go.Palette, "myPaletteDiv",  // create a new Palette in the HTML DIV element
        {
          // share the template map with the Palette
          nodeTemplateMap: myDiagram.nodeTemplateMap,
          autoScale: go.Diagram.Uniform  // everything always fits in viewport
        });
    palette.model.nodeDataArray = [
      { category: "Source" },
      { }, // default node
      { category: "DesiredEvent" },
      { category: "UndesiredEvent", detailsList: [{}] },
      { category: "Comment" }
    ];
    // read in the JSON-format data from the "mySavedModel" element
    load();
    //layout();
  }
  function layout() {
    myDiagram.layoutDiagram(true);
  }
  // Show the diagram's model in JSON format
  function save() {
    document.getElementById("mySavedModel").value = myDiagram.model.toJson();
    myDiagram.isModified = false;
  }
  function load() {
    myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
  }
</script>
</head>
<body onload="init()">
<div id="sample">
  <div style="width: 100%; display: flex; justify-content: space-between">
    <div id="myPaletteDiv" style="width: 100px; margin-right: 2px; background-color: whitesmoke; border: solid 1px black"></div>
    <div id="myDiagramDiv" style="flex-grow: 1; height: 480px; border: solid 1px black"></div>
  </div>

  <button id="SaveButton" onclick="save()">Save</button>
  <button onclick="load()">Load</button>
  <button onclick="layout()">Reset</button>
  <br />
  <textarea id="mySavedModel" style="width:100%;height:300px">
    { "class": "go.GraphLinksModel",
    "copiesArrays": true,
    "copiesArrayObjects": true,
    "nodeDataArray": [ 
  {"key":-1, "category":"Source", "text":"transfer server", "loc":"-1.4210854715202004e-14 19.875448608398447"},
  {"key":-2, "category":"Source", "text":"Start", "loc":"40.951385498046896 94.87544860839836"},
  {"key":0, "text":"Watch for \nPrimetime \nUploads", "loc":"209.90884908522202 3.870046490853248"},
  {"key":5, "text":"Parse the cookie", "loc":"376.7070821174481 22.636872357552264"},
  {"category":"Comment", "text":"Add notes with general comments ", "key":-15, "loc":"1227.0060963526068 212.34150847161482"},
  {"text":"Is local?", "loc":"597.449941004168 22.63687235755235", "key":-6},
  {"category":"UndesiredEvent", "detailsList":[ {"text":"retrieve show name"},{"text":"Compare with repository"} ], "key":-4, "loc":"749.7952321418629 -1.0658141036401503e-13", "text":"Post status update"},
  {"key":-8, "loc":"777.8288887341367 -143.29507406778922", "text":"Launch user approval \nsubworkflow"},
  {"key":-9, "loc":"1011.5395864495758 29.548768879701385", "text":"Merge Episode Data"},
  {"text":"Combine Metadata", "loc":"1251.5415004648557 69.29217388205838", "key":-10},
  {"category":"UndesiredEvent", "detailsList":[ {"text":"  Email"},{"text":"Text message"},{"text":"Log"} ], "key":-11, "loc":"1228.481190748427 -160.38272344652054", "text":"Notify metadata missing"},
  {"category":"DesiredEvent", "key":-3, "loc":"1540.7206442719023 -133.91424900941686", "text":"Failed!"},
  {"text":"Test Asset Type", "loc":"1260.5148179438993 -8.466661992118297", "key":-13},
  {"category":"UndesiredEvent", "detailsList":[ {"text":"Audio files"},{"text":"Video files"} ], "key":-14, "loc":"1508.5214159590232 -15.55176717483539", "text":"Launch media file \nprocessing workflow"},
  {"key":-16, "loc":"1543.0808985697681 139.9659045735176", "text":"Status update"},
  {"category":"DesiredEvent", "key":-17, "loc":"1558.8165881362156 222.8667161133722"}
   ],
    "linkDataArray": [ 
  {"from":-1, "to":0, "points":[139.908849085222,38.52028529090202,163.2421824185553,38.52028529090202,186.5755157518886,38.52028529090202,209.9088490852219,38.52028529090202]},
  {"from":-2, "to":0, "points":[98.95746358717511,113.52028529090202,138.9574635871751,113.52028529090202,159.9088490852219,38.52028529090202,209.9088490852219,38.52028529090202]},
  {"from":0, "to":5, "points":[306.70708211744846,38.52028529090202,330.04041545078184,38.52028529090202,353.37374878411515,38.52028529090202,376.70708211744846,38.52028529090202]},
  {"from":5, "to":-6, "points":[527.4499410041672,38.52028529090202,550.7832743375005,38.52028529090202,574.1166076708339,38.52028529090202,597.4499410041673,38.52028529090202]},
  {"from":-6, "to":-4, "points":[679.7952321418626,38.52028529090202,703.1285654751958,38.52028529090202,726.4618988085291,38.52028529090202,749.7952321418625,38.52028529090202]},
  {"from":-4, "to":5, "points":[929.0095774429049,38.52028529090202,939.0095774429047,38.52028529090202,939.0095774429047,113.52028529090202,839.4024047923837,113.52028529090202,739.7952321418625,113.52028529090202,689.7952321418626,113.52028529090202,638.6225865730149,113.52028529090202,587.4499410041673,113.52028529090202,537.4499410041672,113.52028529090202,376.70708211744846,113.52028529090202,291.3356526740891,113.52028529090202,326.70708211744846,38.52028529090202,376.70708211744846,38.52028529090202]},
  {"from":-8, "to":-9, "points":[970.9151466687063,-118.02824820109008,1010.9151466687063,-118.02824820109008,961.5395864495729,45.43218181305097,1011.5395864495729,45.43218181305097]},
  {"from":-4, "to":-9, "points":[929.0095774429047,38.52028529090202,939.0095774429047,38.52028529090202,961.5395864495729,45.43218181305097,1011.5395864495729,45.43218181305097]},
  {"from":-9, "to":-10, "points":[1190.1813711175416,45.43218181305097,1230.1813711175416,45.43218181305097,1201.5415004648553,85.17558681540784,1251.5415004648553,85.17558681540784]},
  {"from":-11, "to":-3, "points":[1447.3057502828697,-111.92471385141954,1457.3057502828697,-111.92471385141954,1490.720644271905,-115.26941232691365,1540.720644271905,-115.26941232691365]},
  {"from":-8, "to":-11, "points":[970.9151466687063,-118.02824820109008,1010.9151466687063,-118.02824820109008,1178.4811907484288,-111.92471385141954,1228.4811907484288,-111.92471385141954]},
  {"from":-13, "to":-11, "points":[1325.6708972452486,-8.466661992118262,1317.839386612786,-27.564766357355207,1318.7164641719878,-45.898304174618396,1323.8248721923392,-63.48654681810363]},
  {"from":-4, "to":-8, "points":[839.3467478646663,5.219138350942565e-7,839.2970434290885,-34.40055105833638,846.2049152005111,-65.32503392807567,860.868225117287,-92.76142233439086]},
  {"from":-10, "to":-13, "points":[1326.178647615608,69.29217388205824,1317.9252704051746,54.55581106219005,1317.3554317126298,39.22514105969763,1324.7794880713095,23.300163874580957]},
  {"from":-13, "to":-14, "points":[1403.8535172847194,3.3319826058102056,1440.2053199009824,1.2601249296173282,1475.0953165146561,4.461163143779869,1508.53272967767,11.69776143445501]},
  {"from":-14, "to":-16, "points":[1616.4596488575144,80.2394381400523,1621.5578581801228,99.78271980857065,1622.0260207365625,119.68619099508045,1613.5280025702116,139.9659045735176]},
  {"from":-16, "to":-17, "points":[1615.4182854416977,171.7327304402168,1624.230751234377,188.11124975222015,1624.9411634503335,205.15605621723017,1617.8639402865795,222.90228607887457]}
   ]}
  </textarea>
</div>
</body>
</html>